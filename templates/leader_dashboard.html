<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard por Líder</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1, h2 {
      color: #FF5722;
    }
    .charts-container {
      display: flex;
      gap: 50px;
      flex-wrap: wrap;
    }
    canvas {
      background: #f4f4f4;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
    }
    form {
      margin-bottom: 30px;
    }
    label {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>Dashboard por Líder</h1>
  <form method="GET" action="/leader_dashboard">
    <label for="lider_nome">Nome do Líder:</label>
    <select name="lider_nome" id="lider_nome">
      {% for lider in todos_lideres %}
      <option value="{{ lider }}" {% if lider == selected_lider_nome %}selected{% endif %}>{{ lider }}</option>
      {% endfor %}
    </select>

    <label for="data_inicio">Data Início:</label>
    <input type="date" name="data_inicio" value="{{ data_inicio }}">

    <label for="data_fim">Data Fim:</label>
    <input type="date" name="data_fim" value="{{ data_fim }}">

    <button type="submit">Buscar</button>
  </form>

  {% if selected_lider_nome %}
    <h2>Análise: {{ selected_lider_nome }}</h2>
    {% if periodo_filtro %}<p>Período: {{ periodo_filtro }}</p>{% endif %}

    <div class="charts-container">
      <canvas id="radarChart" width="400" height="400"></canvas>
      {% if radar_chart_data_lider.labels and radar_chart_data_lider.data and selected_lider_nome %}
        {% set evolucao_data = [] %}
        {% for row in evaluations_lider %}
          {% if row.area_atuacao == "Esteiras" and row.percentual_atendimento_esteira %}
            {% set _ = evolucao_data.append({"data": row.data_avaliacao, "valor": row.percentual_atendimento_esteira}) %}
          {% endif %}
        {% endfor %}
        {% set datas = evolucao_data | map(attribute='data') | list %}
        {% set valores = evolucao_data | map(attribute='valor') | list %}
        {% if datas and valores %}
          <canvas id="lineChart" width="400" height="400"></canvas>
        {% endif %}
      {% endif %}
    </div>

    <script>
      const radarData = {
        labels: {{ radar_chart_data_lider.labels | tojson }},
        datasets: [{
          label: 'Média dos Critérios',
          data: {{ radar_chart_data_lider.data | tojson }},
          backgroundColor: 'rgba(255, 87, 34, 0.4)',
          borderColor: 'rgba(255, 87, 34, 1)',
          pointBackgroundColor: 'rgba(255, 87, 34, 1)'
        }]
      };

      new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: radarData,
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Radar de Desempenho por Critério' }
          }
        }
      });

      {% if datas and valores %}
      const lineData = {
        labels: {{ datas | tojson }},
        datasets: [{
          label: '% Atendimento - Esteiras',
          data: {{ valores | tojson }},
          borderColor: 'rgba(33, 150, 243, 1)',
          backgroundColor: 'rgba(33, 150, 243, 0.2)',
          tension: 0.3
        }]
      };

      new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: lineData,
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Evolução do % Atendimento - Esteiras' }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
      {% endif %}
    </script>
  {% else %}
    <p>Selecione um líder acima para visualizar o dashboard.</p>
  {% endif %}
</body>
</html>
